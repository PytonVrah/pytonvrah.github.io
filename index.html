<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEDI TEST DUNGEON - NOIR</title>
    
    <!-- Retro Pixel Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            /* PURE MONOCHROME PALETTE */
            --bg-color: #000000;
            --text-color: #ffffff;
            --border-color: #ffffff;
            
            /* IMPORTANT ACCENTS (Only functional colors) */
            --remove-btn: #27ae60; /* Zelená */
            --keep-btn: #c0392b;   /* Červená */
            --hot-color: #ffffff;  /* Hot mode is now white flashing */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'VT323', monospace;
            color: var(--text-color);
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- SCANLINE EFFECT --- */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, .hot-header, .boss-info, .stat-box, .subject-btn, .btn {
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        h1.game-title {
            font-size: 1.5rem;
            margin-top: 80px;
            display: none;
            border-bottom: 2px solid #fff;
            padding-bottom: 10px;
            letter-spacing: 2px;
        }

        h2 { 
            font-size: 1.2rem; 
            color: #fff; 
            border-bottom: 1px solid #fff;
            display: inline-block;
            padding-bottom: 5px;
            margin-bottom: 30px;
        }

        p.content-text {
            font-family: 'VT323', monospace;
            font-size: 2.2rem;
            line-height: 1.3;
            font-weight: 500;
            color: #fff;
            max-width: 90%;
            margin: 0 auto;
        }

        /* --- HUB STYLES --- */
        .hub-container {
            text-align: center;
            z-index: 100;
            padding: 40px;
            background: #000;
            border: 4px solid #fff;
            max-width: 600px;
            width: 90%;
        }

        .hub-title {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .subject-btn {
            background: #000;
            border: 2px solid #fff;
            color: #fff;
            padding: 20px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.1s;
            text-align: center;
            display: block;
            width: 100%;
        }

        .subject-btn:hover {
            background: #fff;
            color: #000;
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0px #fff;
        }

        /* --- UI STATS (TOP) --- */
        .header-ui {
            position: absolute;
            top: 20px;
            width: 90%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 90;
            pointer-events: none;
        }

        .stats-left, .stats-right {
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-box {
            background: #000;
            padding: 10px;
            border: 2px solid #fff;
            color: #fff;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shop-btn {
            background: #000;
            border: 1px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            padding: 10px;
            cursor: pointer;
        }
        .shop-btn:hover { background: #fff; color: #000; }
        .shop-btn:disabled { opacity: 0.3; border-color: #555; color: #555; cursor: not-allowed; }

        .menu-btn {
            background: #000;
            border: 1px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            padding: 8px;
            cursor: pointer;
            pointer-events: auto;
        }
        .menu-btn:hover { background: #fff; color: #000; }

        /* --- CARDS --- */
        .game-wrapper {
            width: 90%; max-width: 600px; position: relative; min-height: 400px;
            display: none; justify-content: center; align-items: center;
        }

        .container { width: 100%; perspective: 1000px; z-index: 10; }

        .card {
            background: transparent;
            min-height: 400px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card.flipped { transform: rotateY(180deg); }

        .card-content, .card-back {
            width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0; 
            padding: 40px;
            box-sizing: border-box;
            background-color: #000;
            border: 4px solid #fff;
        }

        .card-back { transform: rotateY(180deg); background-color: #000; border-style: double; border-width: 6px; }

        /* --- CONTROLS (COLORED) --- */
        .controls {
            display: none; gap: 20px; margin-top: 30px; visibility: hidden; height: 60px; justify-content: center; position: relative;
        }
        .controls.visible { visibility: visible; }

        .btn {
            padding: 15px 30px; 
            border: 4px solid #fff; 
            font-size: 0.9rem; 
            cursor: pointer; 
            color: white; 
            text-transform: uppercase;
            transition: transform 0.1s;
        }
        .btn:active { transform: translate(3px, 3px); }
        
        .btn-remove { background-color: var(--remove-btn); border-color: var(--remove-btn); }
        .btn-keep { background-color: var(--keep-btn); border-color: var(--keep-btn); }

        .key-hint {
            position: absolute;
            bottom: -25px;
            font-size: 0.6rem;
            color: #888;
            font-family: 'Press Start 2P', cursive;
            width: 100%;
            text-align: center;
        }

        /* --- BOSS BAR --- */
        .boss-section {
            width: 90%; max-width: 600px; margin-top: 30px; display: none;
        }
        .boss-info {
            display: flex; justify-content: space-between; margin-bottom: 5px;
            font-size: 0.7rem; color: #fff;
        }
        .boss-bar-frame {
            width: 100%; height: 25px; background: #000; border: 2px solid #fff;
            position: relative;
        }
        .boss-bar-fill {
            height: 100%; width: 100%; transition: width 0.2s;
            background: #fff; 
        }
        /* Rage bars - hatched pattern */
        .boss-bar-fill.phase-2 { 
            background: repeating-linear-gradient(
                45deg,
                #fff,
                #fff 10px,
                #000 10px,
                #000 20px
            );
        }
        .boss-bar-fill.phase-3 { 
            background: repeating-linear-gradient(
                45deg,
                #fff,
                #fff 5px,
                #000 5px,
                #000 10px
            );
        }

        /* --- HOT MODE --- */
        .hot-container {
            display: none; width: 100%;
            background: #000;
            border: 4px solid #fff;
            padding: 30px;
            flex-direction: column; align-items: center;
            animation: pulseBorder 0.5s infinite;
        }

        @keyframes pulseBorder {
            0% { border-color: #fff; }
            50% { border-color: #000; border-style: dashed; }
            100% { border-color: #fff; }
        }

        .hot-header { color: #fff; font-size: 1.2rem; margin-bottom: 20px; }
        
        .timer-bar-bg {
            width: 100%; height: 15px; background: #000; border: 2px solid #fff; margin-bottom: 20px;
        }
        .timer-bar-fill { height: 100%; width: 100%; background: #fff; transition: width 1s linear; }

        .hot-question-text {
            font-family: 'VT323', monospace;
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 30px;
            text-align: center; 
            color: #fff;
        }

        .abcd-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        
        .abcd-btn {
            background: #000; border: 2px solid #fff; color: #fff;
            padding: 20px; font-family: 'VT323', monospace; font-size: 1.5rem;
            cursor: pointer; text-align: left;
            transition: background 0.1s, color 0.1s;
        }
        .abcd-btn:hover { background: #fff; color: #000; }
        
        /* Keyboard Selection Highlight */
        .abcd-btn.key-selected {
            background: #fff; 
            color: #000;
            border-color: #fff;
            position: relative;
        }
        .abcd-btn.key-selected::before {
            content: "> ";
            position: absolute;
            left: 5px;
        }

        .abcd-btn.correct-select { background: #27ae60; border-color: #27ae60; color: white; }
        .abcd-btn.wrong-select { background: #c0392b; border-color: #c0392b; color: white; }

        /* --- ADVERTISEMENT --- */
        .ad-container {
            margin-top: 40px;
            background: #000;
            padding: 10px;
            border: 2px solid #fff;
            text-align: center;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
            box-shadow: 5px 5px 0 #fff;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            z-index: 50;
        }
        .ad-container:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0 #fff; }
        .ad-badge { border: 1px solid #fff; color: #fff; padding: 2px 5px; font-family: 'Press Start 2P', cursive; font-size: 0.5rem; }

        /* --- END SCREEN --- */
        .end-screen { 
            display: none; text-align: center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; padding: 40px; border: 6px double #fff;
            z-index: 200; width: 80%; max-width: 500px;
        }
        .end-screen h2 { font-size: 2.5rem; color: #fff; margin-bottom: 20px; text-decoration: underline; }
        .rank { font-size: 3rem; font-weight: bold; margin: 20px 0; font-family: 'VT323', monospace; color: #fff; }

        /* --- EFFECTS --- */
        .floating-text {
            position: absolute; font-family: 'Press Start 2P', cursive; font-size: 1rem;
            pointer-events: none; animation: floatUp 1s forwards; z-index: 200; 
            color: #fff; text-shadow: 2px 2px 0px #000;
        }
        .text-gain { color: #2ecc71; } /* Green exception */
        .text-loss { color: #c0392b; } /* Red exception */
        
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }

    </style>
</head>
<body>

    <!-- MAIN HUB (MENU) -->
    <div class="hub-container" id="hub-container">
        <h1 class="hub-title">TEDI TEST DUNGEON</h1>
        <p class="hub-subtitle" style="font-family: 'VT323', monospace; font-size: 1.5rem; color: #fff;">[ SELECT DUNGEON ]</p>
        <div class="subject-grid">
            <button class="subject-btn" onclick="startGame('MaM')">MANAZMENT_DUNGEON.EXE</button>
            <button class="subject-btn" onclick="startGame('TM')">MEDIA_THEORY.EXE</button>
        </div>
    </div>

    <!-- HUD -->
    <div class="header-ui" id="header-ui" style="display: none;">
        <div class="stats-left">
            <div class="stat-box hp-display">
                <span>[HP]</span>
                <span id="player-hp">|||||</span>
            </div>
            <div class="stat-box gold-display">
                <span>[G]</span>
                <span id="gold-count">0</span>
            </div>
            <button class="shop-btn" id="btn-buy-potion" onclick="buyPotion()" title="Doplní 1 život (Cena: 50g)">
                [+] HP (50g)
            </button>
        </div>
        
        <div class="stats-right">
            <div class="stat-box combo-display" id="combo-box">
                <span>[X]</span>
                <span id="combo-count">0</span>
            </div>
            <button class="menu-btn" onclick="backToMenu()">[ ESC ]</button>
            <button class="shop-btn" id="btn-buy-hint" onclick="buyHint()" title="V Hot Mode odstráni 2 zlé odpovede (Cena: 30g)" disabled>
                [?] HINT (30g)
            </button>
        </div>
    </div>

    <h1 class="game-title" id="game-title">PREDMET</h1>
    <p id="game-subtitle" style="display: none; opacity: 0.9; margin-bottom: 20px; color: #fff; text-align: center; font-family: 'VT323', monospace; font-size: 1.3rem;">
        > BOSS ENCOUNTER INITIATED...
    </p>

    <!-- GAME WRAPPER -->
    <div id="game-section" class="game-wrapper">
        <!-- STANDARD CARD -->
        <div class="container" id="card-container" onclick="flipCard()">
            <div class="card" id="flashcard">
                <div class="card-content" id="card-front">
                    <h2 id="category-front">Kategória</h2>
                    <p class="content-text" id="question-text">Načítavam...</p>
                </div>
                <div class="card-back" id="card-back">
                    <h2 id="category-back">Odpoveď</h2>
                    <p class="content-text" id="answer-text">...</p>
                </div>
            </div>
        </div>

        <!-- HOT QUESTION CARD -->
        <div class="hot-container" id="hot-container">
            <div class="hot-header">[!!!] HOT ENCOUNTER [!!!]</div>
            <div class="timer-bar-bg">
                <div class="timer-bar-fill" id="timer-fill"></div>
            </div>
            <p class="hot-question-text" id="hot-question-text">Otázka...</p>
            <div class="abcd-grid" id="abcd-options">
                <!-- Buttons via JS -->
            </div>
            <div class="key-hint" style="margin-top: 15px;">[↑/↓] VÝBER &nbsp;&nbsp;&nbsp; [SPACE] POTVRDIŤ</div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls" id="action-controls">
        <button class="btn btn-keep" onclick="keepCard(event)">NEVIEM</button>
        <button class="btn btn-remove" onclick="removeCard(event)">VIEM</button>
        <div class="key-hint">[←] NEVIEM &nbsp;&nbsp;&nbsp; [SPACE] OTOČIŤ &nbsp;&nbsp;&nbsp; [→] VIEM</div>
    </div>

    <!-- BOSS BAR -->
    <div class="boss-section" id="boss-ui">
        <div class="boss-info">
            <span id="boss-name">FINAL BOSS</span>
            <span id="hp-text">100%</span>
        </div>
        <div class="boss-bar-frame">
            <div class="boss-bar-fill" id="boss-health"></div>
        </div>
    </div>

    <!-- ADVERTISEMENT -->
    <a href="https://mmmyster.itch.io/sen-z-ust" target="_blank" class="ad-container">
        <span class="ad-badge">AD</span>
        <span class="ad-text">PLAY: Sen z ust @ Itch.io</span>
    </a>

    <!-- END SCREEN -->
    <div id="end-screen" class="end-screen">
        <h2 id="end-title">VICTORY!</h2>
        <p id="end-msg" style="font-family: 'VT323', monospace; font-size: 1.5rem; color: #fff;">Boss defeated.</p>
        <p style="font-family: 'VT323', monospace; color: #fff;">LOOT:</p>
        <div class="rank" id="final-gold">0 G</div>
        <p style="font-family: 'VT323', monospace; color: #fff;">RANK:</p>
        <div class="rank" id="final-rank">NOVICE</div>
        <button class="btn" onclick="backToMenu()" style="margin-top:20px; border-width:2px;">[ MAIN MENU ]</button>
    </div>

    <script>
        // ================= DATABASES =================

        // 1. MANAŽMENT A MARKETING (MaM)
        const questionsMaM = [
            { q: "Definujte manažment ako vednú disciplínu.", a: "Súbor poznatkov o princípoch, metódach a postupoch riadenia organizácií (empíria + veda)." },
            { q: "Vymenujte funkcie manažmentu (Fayol).", a: "Predvídanie, Organizovanie, Prikazovanie, Koordinovanie, Kontrola." },
            { q: "Skratka POSDCORB (Gulick)?", a: "Planning, Organizing, Staffing, Directing, Coordinating, Reporting, Budgeting." },
            { q: "Definujte rozhodovanie.", a: "Činnosť určovania a analyzovania problému a výberu najvýhodnejšieho riešenia." },
            { q: "Rozhodovanie v riziku?", a: "Poznáme pravdepodobnosť výsledkov, ale nie výsledok samotný." },
            { q: "Brainstorming je?", a: "Skupinová metóda generovania nápadov bez okamžitej kritiky." },
            { q: "SMART ciele sú?", a: "Specific, Measurable, Achievable, Realistic, Time-bound." },
            { q: "Strategické plánovanie?", a: "Dlhodobé (5+ rokov), týka sa celku." },
            { q: "Líniová štruktúra?", a: "Princíp jediného vedúceho, jednoduché vzťahy." },
            { q: "Maticová štruktúra?", a: "Dvojitá podriadenosť (funkčný + projektový vedúci)." },
            { q: "Teória X (McGregor)?", a: "Ľudia sú leniví, potrebujú kontrolu." },
            { q: "Teória Y (McGregor)?", a: "Ľudia sú aktívni, potrebujú motiváciu." },
            { q: "Marketingový mix (4P)?", a: "Product, Price, Place, Promotion." },
            { q: "SWOT analýza?", a: "Strengths, Weaknesses, Opportunities, Threats." },
            { q: "Segmentácia?", a: "Rozdelenie trhu na homogénne skupiny zákazníkov." },
            { q: "PPC reklama?", a: "Platba za kliknutie (Pay Per Click)." },
            { q: "SEO?", a: "Optimalizácia pre vyhľadávače." },
            { q: "Vysvetlite 'Subjektivizmus' v rozhodovaní.", a: "Riziko ovplyvnenia rozhodnutia osobnými názormi a náladou." },
            { q: "Čo je to 'Plochá' OŠR?", a: "Málo stupňov riadenia, široké rozpätie." },
            { q: "Čo sú to 'Mäkké zručnosti'?", a: "Komunikácia, tímová práca, empatia." }
        ];

        // 2. TEÓRIA MÉDIÍ (TM)
        const questionsTM = [
            { q: "Definujte Mediálne štúdiá (M. Bočák).", a: "Vedná disciplína zaoberajúca sa médiami v ich celistvosti, v komplexnom sociálno-kultúrnom kontexte." },
            { q: "Aký je rozdiel medzi TMK a Mediálnymi štúdiami?", a: "TMK: pasívny príjemca, propaganda. MŠ: aktívne publikum, interpretácia." },
            { q: "Vymenujte 4 modely komunikácie (McQuail).", a: "Prenosový, Rituálový, Propagačný, Príjmový." },
            { q: "Lasswellov model komunikácie?", a: "Kto? Hovorí čo? Akým kanálom? Komu? S akým účinkom?" },
            { q: "Vysvetlite Rituálový model komunikácie.", a: "Komunikácia ako zdieľanie, účasť a udržiavanie spoločnosti (nie len prenos info)." },
            { q: "Čo je to Semiotika?", a: "Veda o znakoch a tvorbe významov." },
            { q: "3 typy znakov podľa Peirca?", a: "Ikona (podoba), Index (súvislosť), Symbol (dohoda)." },
            { q: "Rozdiel: Horúce vs. Studené médiá (McLuhan)?", a: "Horúce: veľa dát, nízka participácia. Studené: málo dát, vysoká participácia." },
            { q: "Definujte 'Masu'.", a: "Anonymný, rozptýlený súbor ľudí bez väzieb." },
            { q: "Čo je to 'Gatekeeping'?", a: "Proces výberu informácií do správ (vrátnik)." },
            { q: "Čo je to 'Infotainment'?", a: "Správy podávané zábavnou formou (Info + Entertainment)." },
            { q: "Vysvetlite pojem 'Disneyfikácia'.", a: "Zjednodušenie reality na zábavnú a bezpečnú verziu." },
            { q: "Čo je to 'Žáner'?", a: "Ustálený typ mediálneho produktu so spoločnými znakmi." },
            { q: "Vysvetlite pojem 'Stereotyp'.", a: "Zjednodušený obraz skupiny ľudí, zveličujúci vlastnosti." },
            { q: "Čo je to 'Agenda Setting'?", a: "Médiá určujú, o čom máme premýšľať (nastoľovanie tém)." },
            { q: "Denotácia vs. Konotácia?", a: "Denotácia = doslovný význam. Konotácia = pridaný, emočný význam." }
        ];

        // ================= GAME LOGIC =================

        let currentDeck = [];
        let activeDeckName = "";
        let deck = [];
        
        let gold = 0;
        let playerHP = 5;
        let combo = 0;
        let isFlipped = false;
        let isHotMode = false;
        let hotTimerInterval;
        let selectedHotOptionIndex = -1; // New variable for keyboard selection

        // Elements
        const hubContainer = document.getElementById('hub-container');
        const gameSection = document.getElementById('game-section');
        const controls = document.getElementById('action-controls');
        const bossUi = document.getElementById('boss-ui');
        const headerUi = document.getElementById('header-ui');
        const gameTitle = document.getElementById('game-title');
        const gameSubtitle = document.getElementById('game-subtitle');
        const cardContainer = document.getElementById('card-container');
        const flashcard = document.getElementById('flashcard');
        const questionText = document.getElementById('question-text');
        const answerText = document.getElementById('answer-text');
        const categoryFront = document.getElementById('category-front');
        const bossBar = document.getElementById('boss-health');
        const hpText = document.getElementById('hp-text');
        const bossName = document.getElementById('boss-name');
        const goldDisplay = document.getElementById('gold-count');
        const playerHpDisplay = document.getElementById('player-hp');
        const comboDisplay = document.getElementById('combo-count');
        const comboBox = document.getElementById('combo-box');
        const btnBuyPotion = document.getElementById('btn-buy-potion');
        const btnBuyHint = document.getElementById('btn-buy-hint');
        const hotContainer = document.getElementById('hot-container');
        const hotQuestionText = document.getElementById('hot-question-text');
        const abcdOptions = document.getElementById('abcd-options');
        const timerFill = document.getElementById('timer-fill');

        // --- MENU LOGIC ---

        function startGame(subject) {
            if (subject === 'MaM') {
                currentDeck = [...questionsMaM, ...questionsMaM];
                activeDeckName = "MANAŽMENT A MARKETING";
                bossName.innerText = "BOSS: MANAGER";
            } else if (subject === 'TM') {
                currentDeck = [...questionsTM, ...questionsTM]; 
                activeDeckName = "TEÓRIA MÉDIÍ";
                bossName.innerText = "BOSS: THE MEDIA";
            }

            deck = [...currentDeck];
            gold = 0;
            playerHP = 5;
            combo = 0;
            isFlipped = false;
            isHotMode = false;
            
            hubContainer.style.display = 'none';
            headerUi.style.display = 'flex';
            gameTitle.style.display = 'block';
            gameTitle.innerText = activeDeckName;
            gameSubtitle.style.display = 'block';
            gameSection.style.display = 'flex';
            bossUi.style.display = 'block';
            document.getElementById('end-screen').style.display = 'none';

            updateUI();
            loadCard();
        }

        function backToMenu() {
            headerUi.style.display = 'none';
            gameTitle.style.display = 'none';
            gameSubtitle.style.display = 'none';
            gameSection.style.display = 'none';
            controls.style.display = 'none';
            bossUi.style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            hubContainer.style.display = 'block';
        }

        // --- GAME FUNCTIONS ---

        function updateUI() {
            goldDisplay.innerText = gold;
            // HP Bars like old games |||||
            let hpString = "";
            for(let i=0; i<playerHP; i++) hpString += "|";
            playerHpDisplay.innerText = hpString;

            if(combo > 1) {
                comboBox.style.opacity = "1";
                comboDisplay.innerText = combo + "x";
            } else {
                comboBox.style.opacity = "0";
            }

            const totalCards = currentDeck.length; 
            const currentCards = deck.length;
            const percentage = (currentCards / totalCards) * 100;
            
            bossBar.style.width = `${percentage}%`;
            hpText.innerText = `${Math.round(percentage)}%`;
            
            bossBar.className = 'boss-bar-fill';
            if (percentage < 30) bossBar.classList.add('phase-3');
            else if (percentage < 60) bossBar.classList.add('phase-2');

            btnBuyPotion.disabled = (gold < 50 || playerHP >= 5);
            btnBuyHint.disabled = (gold < 30 || !isHotMode);
        }

        function showFloatingText(text, type) {
            const el = document.createElement('div');
            el.className = `floating-text ${type}`;
            el.innerText = text;
            el.style.left = '50%';
            el.style.top = '40%';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- SHOP ---
        function buyPotion() {
            if(gold >= 50 && playerHP < 5) {
                gold -= 50;
                playerHP++;
                showFloatingText("[+HP]", "text-gain");
                updateUI();
            }
        }

        function buyHint() {
            if(gold >= 30 && isHotMode) {
                gold -= 30;
                const buttons = Array.from(abcdOptions.querySelectorAll('button:not(.correct-select)'));
                let wrongButtons = buttons.filter(btn => !btn.dataset.isCorrect);
                for(let i=0; i<2 && i<wrongButtons.length; i++) {
                    wrongButtons[i].classList.add('hidden-hint');
                }
                btnBuyHint.disabled = true;
                updateUI();
            }
        }

        // --- CORE LOOP ---
        function loadCard() {
            if (playerHP <= 0) { gameOver(); return; }
            if (deck.length === 0) { victory(); return; }

            clearInterval(hotTimerInterval);
            hotContainer.style.display = 'none';
            cardContainer.style.display = 'block';
            controls.style.display = 'flex';
            controls.classList.remove('visible');
            flashcard.classList.remove('flipped');
            isFlipped = false;
            isHotMode = false;

            // Chance logic
            let hotChance = 0.1;
            if (deck.length === currentDeck.length) hotChance = 0; // First card safe

            if (Math.random() < hotChance) {
                startHotMode();
            } else {
                startNormalMode();
            }
            updateUI();
        }

        function startNormalMode() {
            const currentCard = deck[0];
            let cat = "[ OTÁZKA ]";
            categoryFront.innerText = cat;
            questionText.innerText = currentCard.q;
            answerText.innerText = currentCard.a;
        }

        function startHotMode() {
            isHotMode = true;
            selectedHotOptionIndex = -1; // Reset keyboard selection
            cardContainer.style.display = 'none';
            controls.style.display = 'none';
            hotContainer.style.display = 'flex';
            updateUI(); 

            const currentCard = deck[0];
            hotQuestionText.innerText = currentCard.q;
            const correctAnswer = currentCard.a;
            
            const otherAnswers = currentDeck
                .filter(item => item.a !== correctAnswer)
                .map(item => item.a)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3);
            
            const allOptions = [...otherAnswers, correctAnswer].sort(() => 0.5 - Math.random());

            abcdOptions.innerHTML = '';
            allOptions.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'abcd-btn';
                btn.innerText = opt;
                if(opt === correctAnswer) btn.dataset.isCorrect = "true";
                btn.onclick = () => checkHotAnswer(btn, opt === correctAnswer);
                // Assign an ID for easier keyboard selection
                btn.id = `hot-opt-${index}`;
                abcdOptions.appendChild(btn);
            });

            // Initial highlight for first option if using keyboard
            if(abcdOptions.children.length > 0) {
                selectedHotOptionIndex = 0;
                updateHotSelection();
            }

            let duration = 10;
            timerFill.style.width = '100%';
            timerFill.style.transition = 'none';
            void timerFill.offsetWidth;
            timerFill.style.transition = `width ${duration}s linear`;
            timerFill.style.width = '0%';

            hotTimerInterval = setTimeout(() => {
                if(isHotMode) handleHotResult(false);
            }, duration * 1000);
        }

        function updateHotSelection() {
            const buttons = abcdOptions.querySelectorAll('button');
            buttons.forEach((btn, index) => {
                if (index === selectedHotOptionIndex) {
                    btn.classList.add('key-selected');
                } else {
                    btn.classList.remove('key-selected');
                }
            });
        }

        function checkHotAnswer(btn, isCorrect) {
            clearTimeout(hotTimerInterval);
            const buttons = abcdOptions.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            if(isCorrect) {
                btn.classList.add('correct-select');
                handleHotResult(true);
            } else {
                btn.classList.add('wrong-select');
                handleHotResult(false);
            }
        }

        function handleHotResult(success) {
            if(success) {
                combo++;
                let gain = 50 + (combo * 10);
                gold += gain;
                showFloatingText(`+${gain}G`, "text-hot-gain");
                deck.shift(); 
            } else {
                combo = 0;
                gold -= 30;
                playerHP--;
                showFloatingText("-1 HP", "text-loss");
                hotContainer.classList.add('shake');
                setTimeout(() => hotContainer.classList.remove('shake'), 500);
                const card = deck.shift();
                deck.push(card);
            }
            updateUI();
            setTimeout(loadCard, 1500);
        }

        function flipCard() {
            if(isHotMode) return;
            if (deck.length === 0) return;
            isFlipped = !isFlipped;
            flashcard.classList.toggle('flipped');
            if(isFlipped) controls.classList.add('visible');
            else controls.classList.remove('visible');
        }

        function removeCard(e) {
            e.stopPropagation();
            combo++;
            let multiplier = 1 + (combo * 0.1);
            let gain = Math.floor(20 * multiplier);
            gold += gain;
            showFloatingText(`+${gain}G`, "text-gain");
            cardContainer.classList.add('shake');
            setTimeout(() => cardContainer.classList.remove('shake'), 500);
            deck.shift();
            loadCard();
        }

        function keepCard(e) {
            e.stopPropagation();
            combo = 0;
            gold -= 10;
            playerHP--;
            showFloatingText("-1 HP", "text-loss");
            const current = deck.shift();
            deck.push(current);
            loadCard();
        }

        function victory() { showEndScreen("VICTORY!", "DUNGEON CLEARED", "#fff"); }
        function gameOver() { showEndScreen("GAME OVER", "YOU DIED", "#c0392b"); }

        function showEndScreen(title, msg, color) {
            gameSection.style.display = 'none';
            bossUi.style.display = 'none';
            controls.style.display = 'none';
            document.getElementById('end-screen').style.display = 'block';
            document.getElementById('end-title').innerText = title;
            document.getElementById('end-title').style.color = color;
            document.getElementById('end-msg').innerText = msg;
            document.getElementById('final-gold').innerText = `${gold} G`;
            
            let rank = "NOOB";
            if (gold < 0) rank = "CORPSE";
            else if (gold < 1000) rank = "APPRENTICE";
            else if (gold < 2500) rank = "ADVENTURER";
            else rank = "HERO";
            document.getElementById('final-rank').innerText = rank;
        }

        document.addEventListener('keydown', function(event) {
            // Only active if game section is visible
            if (document.getElementById('game-section').style.display === 'none') return;

            if (isHotMode) {
                const buttons = abcdOptions.querySelectorAll('button');
                if (buttons.length === 0) return;

                if (event.code === 'ArrowUp') {
                    event.preventDefault();
                    selectedHotOptionIndex = (selectedHotOptionIndex - 1 + buttons.length) % buttons.length;
                    updateHotSelection();
                } else if (event.code === 'ArrowDown') {
                    event.preventDefault();
                    selectedHotOptionIndex = (selectedHotOptionIndex + 1) % buttons.length;
                    updateHotSelection();
                } else if (event.code === 'Space' || event.code === 'Enter') {
                    event.preventDefault();
                    if(selectedHotOptionIndex >= 0 && !buttons[selectedHotOptionIndex].disabled) {
                        buttons[selectedHotOptionIndex].click();
                    }
                }
                return;
            }

            // Standard Card Mode
            if (event.code === 'Space') {
                event.preventDefault(); // Prevent scrolling
                flipCard();
            } else if (event.code === 'ArrowLeft') {
                if (isFlipped) keepCard(event); 
            } else if (event.code === 'ArrowRight') {
                if (isFlipped) removeCard(event);
            }
        });

    </script>
</body>
</html>